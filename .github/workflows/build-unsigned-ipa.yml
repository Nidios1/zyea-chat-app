name: Build Unsigned IPA (for ESign)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-unsigned-ipa:
    name: Build Unsigned iOS App
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./zyea-plus-app
        run: npm ci

      - name: Build React app
        working-directory: ./zyea-plus-app
        run: |
          DISABLE_ESLINT_PLUGIN=true npm run build

      - name: Sync Capacitor
        working-directory: ./zyea-plus-app
        run: |
          npx cap sync ios

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Install iOS dependencies
        working-directory: ./zyea-plus-app/ios/App
        run: pod install

      - name: Build iOS app (Unsigned)
        working-directory: ./zyea-plus-app/ios/App
        run: |
          # Build without signing
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath $PWD/build/App.xcarchive \
            archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS=""

      - name: Create unsigned IPA
        working-directory: ./zyea-plus-app/ios/App
        run: |
          # Create Payload directory
          mkdir -p $PWD/build/Payload
          
          # Copy app to Payload
          cp -r $PWD/build/App.xcarchive/Products/Applications/App.app $PWD/build/Payload/
          
          # Create IPA
          cd $PWD/build
          zip -r ZyeaPlus-Unsigned.ipa Payload
          
          # Verify IPA was created
          ls -lh ZyeaPlus-Unsigned.ipa
          echo "‚úÖ Unsigned IPA created successfully!"

      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: ZyeaPlus-Unsigned-IPA
          path: zyea-plus-app/ios/App/build/ZyeaPlus-Unsigned.ipa
          retention-days: 30

      - name: Create Release with IPA
        uses: softprops/action-gh-release@v1
        with:
          tag_name: unsigned-v1.0.${{ github.run_number }}
          name: Zyea+ Unsigned iOS Build #${{ github.run_number }}
          body: |
            ## üöÄ Zyea+ Unsigned iOS Build
            
            **Build Number**: ${{ github.run_number }}
            **Build Date**: ${{ github.event.head_commit.timestamp }}
            **Commit**: ${{ github.sha }}
            
            ### üì¶ File ƒë·ªÉ t·∫£i:
            - `ZyeaPlus-Unsigned.ipa` - File IPA ch∆∞a k√Ω
            
            ### ‚úèÔ∏è C√°ch k√Ω b·∫±ng ESign:
            
            1. **T·∫£i ESign** t·ª´: https://esign.yyyue.xyz/
            2. **Import IPA** v√†o ESign
            3. **Ch·ªçn certificate** ƒë·ªÉ k√Ω
            4. **Sign & Install** l√™n iPhone
            
            ### üì± C√°ch c√†i ƒë·∫∑t:
            
            **Option 1: ESign (Khuy·∫øn ngh·ªã)**
            - C√†i ESign qua AltStore ho·∫∑c Sideloadly
            - Import file IPA n√†y v√†o ESign
            - K√Ω v√† c√†i ƒë·∫∑t tr·ª±c ti·∫øp
            
            **Option 2: Sideloadly**
            - M·ªü Sideloadly
            - Drag & drop file IPA
            - Nh·∫≠p Apple ID
            - Click Start
            
            **Option 3: AltStore**
            - M·ªü AltStore
            - My Apps ‚Üí + 
            - Ch·ªçn file IPA
            - ƒê·ª£i c√†i ƒë·∫∑t
            
            ### ‚ö†Ô∏è L∆∞u √Ω:
            - File IPA n√†y **CH∆ØA ƒê∆Ø·ª¢C K√ù**
            - C·∫ßn k√Ω b·∫±ng certificate c·ªßa b·∫°n ƒë·ªÉ c√†i ƒë·∫∑t
            - Sau khi c√†i: Settings ‚Üí General ‚Üí Device Management ‚Üí Trust
            
            ---
            **Built with ‚ù§Ô∏è for Zyea+ Team**
          files: |
            zyea-plus-app/ios/App/build/ZyeaPlus-Unsigned.ipa
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        if: success()
        run: |
          echo "üéâ =================================="
          echo "‚úÖ BUILD TH√ÄNH C√îNG!"
          echo "===================================="
          echo ""
          echo "üì¶ File IPA ƒë√£ ƒë∆∞·ª£c t·∫°o:"
          echo "   - ZyeaPlus-Unsigned.ipa"
          echo ""
          echo "üì• Download t·∫°i:"
          echo "   - Artifacts (ph√≠a d∆∞·ªõi)"
          echo "   - Releases: https://github.com/${{ github.repository }}/releases"
          echo ""
          echo "‚úèÔ∏è K√Ω b·∫±ng ESign:"
          echo "   1. T·∫£i ESign: https://esign.yyyue.xyz/"
          echo "   2. Import IPA v√†o ESign"
          echo "   3. Ch·ªçn certificate"
          echo "   4. Sign & Install"
          echo ""
          echo "üéØ Ho√†n th√†nh!"
          echo "===================================="

      - name: Error Details
        if: failure()
        run: |
          echo "‚ùå BUILD TH·∫§T B·∫†I!"
          echo "Ki·ªÉm tra logs ph√≠a tr√™n ƒë·ªÉ xem l·ªói chi ti·∫øt."

